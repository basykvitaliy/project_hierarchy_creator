package com.example.structureplugin

import com.intellij.openapi.actionSystem.AnAction
import com.intellij.openapi.actionSystem.AnActionEvent
import com.intellij.openapi.vfs.VfsUtil
import com.intellij.openapi.ui.Messages
import java.io.File

class CreateStructureAction : AnAction("Create Project Structure") {
    override fun actionPerformed(e: AnActionEvent) {
        val project = e.project ?: return
        val basePath = project.basePath ?: return

        // üîπ —à—É–∫–∞—î–º–æ –Ω–∞–π—Ç–∏–ø–æ–≤—ñ—à–∏–π MainActivity.kt –∞–±–æ –±—É–¥—å-—è–∫–∏–π Activity
        val mainFile = File(basePath).walkTopDown().firstOrNull {
            it.isFile && it.extension == "kt" &&
                    (it.name.contains("MainActivity", true) || it.readText().contains("class MainActivity"))
        }

        // üîπ —è–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ ‚Äî –±–µ—Ä–µ–º–æ –±—É–¥—å-—è–∫–∏–π .kt —É kotlin+java/‚Ä¶/com/‚Ä¶/
        val targetDir = mainFile?.parentFile ?: File(basePath)
            .walkTopDown()
            .firstOrNull { it.isDirectory && it.path.replace("\\", "/").contains("app/src/main/") && it.name == "ui" }
            ?.parentFile
        ?: File(basePath, "app/src/main")

        // üîπ —Å—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Ä—É—á —ñ–∑ MainActivity
        val folders = listOf(
            "data/repository",
            "data/model",
            "domain/usecase",
            "ui/screens",
            "ui/components"
        )

        for (folder in folders) {
            val dir = File(targetDir, folder)
            if (!dir.exists()) dir.mkdirs()
            val readme = File(dir, "README.md")
            if (!readme.exists()) {
                readme.writeText("# ${folder.substringAfterLast('/')}\n\nAutogenerated folder description.")
            }
        }

        VfsUtil.markDirtyAndRefresh(false, true, true, File(basePath))
        Messages.showInfoMessage(
            project,
            "Folders created inside: ${targetDir.path}",
            "Done"
        )
    }
}
